---
title: "Bird Detections"
author: "Brianna Saylor"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: FALSE
    toc_float: TRUE
wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr) # data manipulation
library(ggplot2) # making graphs
library(tidyverse)  # importing, tidying, plotting data
library(knitr)      # making tables in markdown
library(leaflet)    # making maps in markdown 
library(hexbin)
library(tidyr) # data manipulation 
library(lubridate) # used to change date format
library(lme4) # running mixed models 
library(MuMIn)
obs <- read.csv("data/grassland-bird-species-obs_09July25.csv")
veg <- read.csv("data/grassland-bird-veg_09July25.csv")
point.count <- read.csv("data/grassland-bird-point-count_18Sept25.csv")
```

```{r clean observation data, echo=FALSE, include=FALSE}
# check data for issues 
summary(obs)
obs$point_id <- as.factor(obs$point_id) # point id factor
obs$species <- as.factor(obs$species) # species factor 
obs$flyover <- as.factor(obs$flyover) # flyover factor 
unique(obs$point_id)
summary(obs)
```

```{r clean up vegetation data, echo=FALSE, include=FALSE}
summary(veg)
veg$point_id <- as.factor(veg$point_id) # point id factor 
unique(veg$point_id)
summary(veg)
```

```{r clean up point count data, echo=FALSE, include=FALSE}
summary(point.count)
names(point.count)[names(point.count) == "X...point_id"] <- "point_id"
point.count$point_id <- as.factor(point.count$point_id) # point id as factor
point.count <- point.count %>% 
  mutate(date = dmy(date)) # change date format to year-month-day
summary(point.count)
```

```{r filtering observation data, include=FALSE}
obs.nofly.100 <- filter(obs, flyover == "No") # remove observations that are flyovers
obs.nofly.100 <- filter(obs.nofly.100, dist <= 100) # remove observations over 100 m from point
```

```{r summarize individuals by point id, include=FALSE}
detections <- obs.nofly.100 %>% 
  group_by(point_id) %>% 
  summarise(total_individuals = sum(number))
```

```{r calculating time since sunrise, message=FALSE, include=FALSE}
# calculating sunrise time in UTC, must have columns for date/lat/lon titled exactly that
library(suncalc)
sun.times <- getSunlightTimes(
  data = point.count, 
  keep = "sunrise")
 # sun.times$sunrise <- format(sun.times$sunrise, format = "%H:%M:%S")
point.count <- point.count %>% 
  mutate(getSunlightTimes(
    data = point.count,
    keep = "sunrise"))
# convert local times to proper format for conversion
point.count <- point.count %>% 
  mutate(
    date_time = paste(date, start_time),
    date_time = ymd_hm(date_time),
    date_time = case_when(
      zone == "central" ~ force_tz(date_time, "America/Chicago"),
      zone == "eastern" ~ force_tz(date_time, "America/New_York")),
    date_time_utc = with_tz(date_time, "UTC"))
# calculate the minutes since sunrise 
point.count <- point.count %>% 
  mutate(min_from_sunrise = round(
    as.numeric(difftime(date_time_utc, sunrise, units = "mins")),2))
```

```{r removing columns from point count data, echo=FALSE, include=FALSE} 
point.count <- point.count %>% 
  dplyr::select(-observer, -temp, -wind, -cloud, -start_time, -lat, -lon, -zone, -sunrise, -date_time, -date_time_utc, -date)
```

```{r preparing the veg data, echo=FALSE, include=FALSE}
veg <- veg %>% 
  dplyr::select(-date, -basal_area, -site_type, -vd_max, -vd_avg, -pc_woody, -pc_forb, -pc_bramble, -pc_noveg, -pc_litter, -pc_bare, -site_pa_ratio)
```

```{r combining into one df, include=FALSE}
combined.detections <- veg %>% 
  full_join(detections, by = "point_id") %>% 
  full_join(point.count, by = "point_id")
combined.detections <- combined.detections %>% 
  mutate(across(c(total_individuals), ~replace_na(.x, 0))) # replace NA values with 0
sum(is.na(combined.detections)) # check for NAs
```

Point count surveys were completed across Tennessee looking for grassland birds. Surveyors examined which characteristics impacted the total number of birds detected at point counts. They measured environmental characteristics including litter depth, vegetation height, vegetation density, and percent cover of grass. Additionally, they measured the size of the site in hectares and the start time of the survey (minutes after sunrise). 

What does our data look like?

```{r summary detections, echo=FALSE}
summary.detections <- combined.detections %>% 
  summarise(
  median = median(total_individuals),
  mean = mean(total_individuals), 
  min = min(total_individuals), 
  max = max(total_individuals))
kable(summary.detections, caption = "A summary kable dispaying the median, mean, minimum, and maximum number of detections at surveys.", digits = c(0, 2, 0, 0))
```

```{r histogram detections all data, echo=FALSE, message=FALSE, fig.align='center'}
ggplot(combined.detections, aes(x = total_individuals)) + 
  geom_histogram() + 
  theme_classic() + 
  xlab("Number of Detections") + 
  ylab("Count")
```

Will probably have some outliers in the data. Need to keep on eye out for this.  

```{r global model}
glm.global <- glm(total_individuals ~ litter_avg + veg_ht_avg + vd_vo + pc_grass + site_ha + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
summary(glm.global) 
```

```{r global model performance, fig.width=10, fig.height=8, fig.align='center', warning=FALSE, message=FALSE}
library(easystats)
check_model(glm.global) 
```

There are 2 outliers in the data which are much higher counts compared to the rest of the data. Let's remove those. 

```{r remove outliers, include=FALSE}
combined.detections <- combined.detections[-c(50,98),]
glm.global.2 <- glm(total_individuals ~ litter_avg + veg_ht_avg + vd_vo + pc_grass + site_ha + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
summary(glm.global.2) 
```

```{r global model performance no outliers, fig.width=10, fig.height=8, fig.align='center'}
check_model(glm.global.2) 
```

We have a moderate amount of dispersion. 

What does our data look like now that we have removed the outliers?
```{r histogram detections no outliers, echo=FALSE, message=FALSE, fig.align='center'}
ggplot(combined.detections, aes(x = total_individuals)) + 
  geom_histogram(bins = 20) + 
  theme_classic() + 
  xlab("Number of Detections") + 
  ylab("Count")
```


```{r collinearity, message=FALSE, fig.align='center', warning=FALSE}
# check for collinearity 
library(GGally)
ggpairs(combined.detections, columns = c(2, 3, 4, 5, 6, 8)) + theme_bw()
```

Vegetation height and vegetation density appear to be highly correlated. Need to be careful of that in the models. 

```{r}
# check for multicollinearity
library(performance)
performance::check_collinearity(glm.global.2)
```

VIF values are <5 so we do not need to worry about multicollinearity. 

```{r model list, include=FALSE}
m1 <- glm(total_individuals ~ veg_ht_avg + pc_grass, family = poisson(link = "log"), data = combined.detections)
m2 <- glm(total_individuals ~ site_ha + pc_grass, family = poisson(link = "log"), data = combined.detections)
m3 <- glm(total_individuals ~ site_ha + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
m4 <- glm(total_individuals ~ litter_avg + veg_ht_avg + pc_grass, family = poisson(link = "log"), data = combined.detections)
m5 <- glm(total_individuals ~ vd_vo + pc_grass + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
m6 <- glm(total_individuals ~ pc_grass + site_ha + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
m7 <- glm(total_individuals ~ litter_avg + veg_ht_avg + pc_grass + site_ha, family = poisson(link = "log"), data = combined.detections)
m8 <- glm(total_individuals ~ veg_ht_avg + pc_grass + site_ha + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
m9 <- glm(total_individuals ~ litter_avg + vd_vo + pc_grass + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
m10 <- glm(total_individuals ~ vd_vo + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
m11 <- glm(total_individuals ~ pc_grass + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
m12 <- glm(total_individuals ~ litter_avg + veg_ht_avg + vd_vo + pc_grass + site_ha + min_from_sunrise, family = poisson(link = "log"), data = combined.detections)
# place models in an object 
models <- list(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11, m12)
```

```{r display model list}
# display list of ranked models
model_comparison <- model.sel(models)
model_comparison
```

```{r best supported models}
# select best supported models 
subset(model_comparison, delta <5)
```

Model 5, 9, and 8 all have delta AICc <2. Model 5 is 2.34 times more likely than model 9. (0.508/0.217=2.34) The global model does have a delta AICc <5. 

```{r calculate variable importance weights}
# calculate variable importance weights 
MuMIn::sw(model_comparison)
```

```{r model averageing}
# model averaging 
model.avg <- model.avg(model_comparison, revised.var = TRUE)
model.avg
```

Now we can look at the direction of impact these variables have with the number of bird detections. 

```{r report model average}
summary(model.avg(model_comparison, subset = delta < 2))
```

```{r back transform coefficients}
# calculating the exponentiated coefficients of our averaged model
exp(coef(model.avg))
```

We can expect the following relationships: 
  -Minutes from sunrise: 0.2% decrease in bird detections for every minute after sunrise 
  -Percent grass: 1.3% increase in bird detections per 1% increase in grass cover
  -Vegetation density: 0.4% increase in bird detections with 1 unit increase in vegetation density
  -Litter depth: 0.1% increase in bird detections with 1 cm increase in litter depth 
  -Vegetation height: 0.3% increase in bird detections with every 1 cm increase in vegetation height 
  -Site size: 0.02% decrease in bird detections with every 1 ha increase in site size

      
In conclusion, the factors that impact bird detections include survey start time, the percent cover of grass, and the vegetation density. To maximize detections surveys should be conducted closer to sunrise, in areas with large amounts of grass, and in areas with dense vegetation. 